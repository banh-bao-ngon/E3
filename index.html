<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Protocols Calculator</title>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Vercel Analytics temporarily disabled for debugging -->
    <!--
    <script type="module">
      import { injectSpeedInsights } from 'https://cdn.skypack.dev/@vercel/speed-insights';
      import { inject } from 'https://cdn.skypack.dev/@vercel/analytics';

      injectSpeedInsights();
      inject();
    </script>
    -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007bff">
</head>
<body onkeydown="handleGlobalKeydown(event)">
<!-- Clinical Disclaimer Banner -->
<div id="disclaimer-banner" class="disclaimer-banner">
    <i class="fas fa-exclamation-triangle"></i>
    <span>This tool is for clinical reference only. Always use clinical judgment and verify calculations independently.</span>
    <button onclick="acceptDisclaimer()" class="accept-btn">I Understand</button>
</div>

<!-- Dark Mode Toggle -->
<button id="dark-mode-toggle" class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
    <i class="fas fa-moon"></i>
</button>

<!-- History Panel Toggle -->
<button id="history-toggle" class="history-toggle" onclick="toggleHistory()" title="Calculation History">
    <i class="fas fa-history"></i>
    <span class="history-count" id="history-count">0</span>
</button>

<!-- Feedback Button -->
<button id="feedback-toggle" class="feedback-toggle" onclick="toggleFeedback()" title="Leave Feedback">
    <i class="fas fa-comment-dots"></i>
</button>

<!-- Monitoring Panel Toggle -->
<button id="monitoring-toggle" class="monitoring-toggle" onclick="toggleMonitoringPanel()" title="Monitoring & Alerts">
    <i class="fas fa-chart-line"></i>
    <span class="flag-badge" id="flag-badge" style="display: none;"></span>
</button>

<div id="history-panel" class="history-panel">
    <div class="history-header">
        <h3>Calculation History</h3>
        <div>
            <button onclick="clearHistory()" class="clear-history-btn" title="Clear All History">Clear All</button>
            <button onclick="toggleHistory()" class="close-history-btn" title="Close Panel">&times;</button>
        </div>
    </div>
    <div id="history-content" class="history-content">
        <p class="history-empty">No calculations yet</p>
    </div>
</div>

<!-- Monitoring Panel -->
<div id="monitoring-panel" class="monitoring-panel">
    <div class="monitoring-header">
        <h3>Clinical Monitoring</h3>
        <button onclick="toggleMonitoringPanel()" class="close-monitoring-btn" title="Close Panel">&times;</button>
    </div>

    <!-- Timer Section -->
    <div class="monitoring-section">
        <h4><i class="fas fa-clock"></i> Assessment Timer</h4>
        <div class="timer-controls">
            <div class="timer-display-container">
                <div id="timer-display" class="timer-display">60:00</div>
                <div id="target-time-display" class="target-time">Target: --:--:--</div>
            </div>
            <div class="timer-buttons">
                <button id="timer-start-btn" onclick="startTimer()" class="timer-btn timer-start">Start</button>
                <button id="timer-stop-btn" onclick="stopTimer()" class="timer-btn timer-stop" disabled>Stop</button>
                <button id="timer-reset-btn" onclick="resetTimer()" class="timer-btn timer-reset">Reset</button>
            </div>
        </div>
    </div>

    <!-- Monitoring Status -->
    <div class="monitoring-section">
        <h4><i class="fas fa-chart-bar"></i> Status</h4>
        <div id="monitoring-status" class="monitoring-status">
            <div class="status-item">
                <span class="status-label">Total Readings:</span>
                <span class="status-value">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Active Flags:</span>
                <span class="status-value">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Timer:</span>
                <span class="status-value">Stopped</span>
            </div>
        </div>
    </div>

    <!-- Tracking Graph -->
    <div class="monitoring-section">
        <h4><i class="fas fa-chart-line"></i> Tracking Data</h4>
        <div class="graph-controls">
            <select id="graph-type-select" onchange="updateGraph()">
                <option value="bg">Blood Glucose</option>
                <option value="rate">Infusion Rate</option>
                <option value="both">Both</option>
            </select>
            <select id="graph-timeframe-select" onchange="updateGraph()">
                <option value="6">Last 6 Hours</option>
                <option value="12">Last 12 Hours</option>
                <option value="24">Last 24 Hours</option>
            </select>
        </div>
        <div class="graph-container">
            <canvas id="tracking-chart" width="350" height="200"></canvas>
        </div>
        <div class="data-management">
            <h5><i class="fas fa-trash-alt"></i> Data Management</h5>
            <div class="data-clear-buttons">
                <button onclick="clearTrackingData('bg')" class="clear-btn clear-bg">Clear BG Data</button>
                <button onclick="clearTrackingData('rates')" class="clear-btn clear-rates">Clear Rate Data</button>
                <button onclick="clearTrackingData('all')" class="clear-btn clear-all">Clear All Data</button>
            </div>
            <div class="data-summary">
                <span id="data-summary-text">Loading data summary...</span>
            </div>
        </div>
    </div>

    <!-- Active Flags -->
    <div class="monitoring-section">
        <h4><i class="fas fa-exclamation-triangle"></i> Active Alerts</h4>
        <div id="flags-container" class="flags-container">
            <p class="no-flags">No active alerts</p>
        </div>
    </div>
</div>

 <div class="main-wrapper">
     <div class="tabs">
         <button class="tab-button active" data-protocol="heparin" onclick="switchTab('heparin')">Heparin Protocol</button>
         <button class="tab-button" data-protocol="insulin" onclick="switchTab('insulin')">Insulin Protocol</button>
         <button class="tab-button" data-protocol="calculator" onclick="switchTab('calculator')">Calculator</button>
         <button class="tab-button" data-protocol="gemini-ai" onclick="switchTab('gemini-ai')">Dat AI Assistant</button>
         <button class="tab-button" data-protocol="other" onclick="switchTab('other')">Other Protocols</button>
     </div>

     <div class="tab-content">
         <!-- Heparin Protocol Tab -->
         <div id="heparin-protocol-content" class="protocol-content active">
             <div class="container">
                 <h1>Heparin Anticoagulation Protocol</h1>
                 <div class="input-group">
                     <label for="heparin-aptt">Enter aPTT value:</label>
                     <input type="number" id="heparin-aptt" min="0" max="500" placeholder="e.g., 85" onkeypress="if(event.key==='Enter'){event.preventDefault();getHeparinInstructions();}">
                     <button onclick="getHeparinInstructions()">Get Instructions</button>
                     <a href="heparinQuickGuide-StandardVTE.pdf" download>Download Protocol PDF</a>
                 </div>
                 <div id="heparin-results" class="results-container">
                 </div>
             </div>
             <div class="lab-monitoring-section">
                 <h2>LAB MONITORING</h2>
                 <div class="lab-monitoring-content">
                     <div class="column">
                         <h3>Activated Partial Thromboplastin Time (aPTT)</h3>
                         <ul>
                             <li>Draw STAT aPTT q6hrs after starting drip</li>
                             <li>Round aPTT result to nearest whole number</li>
                             <li>Adjust DOSE based on protocol chart</li>
                         </ul>
                         <h3>aPTT Timing</h3>
                         <ul>
                             <li><strong>Dose change:</strong> count 6 hours from time of dose adjustment.</li>
                             <li><strong>No change:</strong> count 6 hours from aPTT result time.</li>
                             <li>After 2 consecutive therapeutic aPTTs, switch to daily draws.</li>
                             <li>If a daily aPTT is out of range, restart q6hr draws.</li>
                         </ul>
                         <h3>Discontinuing aPTTs</h3>
                         <ul>
                             <li>Discontinue aPTT draws once heparin is stopped.</li>
                         </ul>
                         <h3>CBC</h3>
                         <ul>
                             <li>Draw CBC with platelets the day after heparin start.</li>
                             <li>Then, every 3 days minimum while on heparin.</li>
                         </ul>
                         <p class="warning">
                             <i class="fas fa-exclamation-triangle"></i>
                             If unable to draw labs or patient refuses, notify provider immediately.
                         </p>
                     </div>
                 </div>
             </div>
         </div>

         <!-- Insulin Protocol Tab -->
         <div id="insulin-protocol-content" class="protocol-content">
             <div class="container">
                 <h1>Insulin Protocol</h1>
                 <div class="input-group">
                     <label for="insulin-protocol-select">Select Protocol:</label>
                     <select id="insulin-protocol-select" onchange="switchInsulinProtocol(this.value)">
                         <option value="non-dka-hhs">Non-DKA/HHS Insulin Drip</option>
                         <option value="dka-hhs">DKA/HHS Insulin Drip</option>
                     </select>
                 </div>

                 <!-- NON-DKA/HHS PROTOCOL -->
                 <div id="non-dka-hhs-protocol" style="display: block;">
                      <div class="input-group">
                         <a href="Insulin_Non-DKA_122020.pdf" download>Download Protocol PDF</a>
                     </div>
                     <h2>Goal Blood Glucose: 140-180 mg/dL</h2>
                     <div class="info-section">
                         <h3>Calculation of Initial Infusion Rate</h3>
                         <div class="input-group">
                             <label for="insulin-bg">Enter Current BG (mg/dL):</label>
                             <input type="number" id="insulin-bg" min="0" max="1500" placeholder="e.g., 210" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateInsulinRate();}">
                             <button onclick="calculateInsulinRate()">Calculate Rate</button>
                         </div>
                         <div id="insulin-rate-results" class="results-container"></div>
                     </div>
                     <div class="info-section">
                         <h3>Optional Initial Bolus</h3>
                         <ul>
                             <li>Administer initial bolus equal to starting rate of infusion (e.g., starting rate 3 units per hour, bolus= 3 units) <b>REQUIRES PHYSICIAN ORDER</b></li>
                             <li>Do not administer an additional bolus if insulin infusion has already started (e.g., insulin infusion started in the Emergency Department prior to admission)</li>
                         </ul>
                     </div>
                     <div class="info-section">
                         <h3>Adjustment of Existing Infusion Rate</h3>
                         <p class="section-subtitle"><strong>Remember hourly BG checks</strong>.</p>
                         <div class="input-stack">
                             <div class="input-row">
                                 <label for="current-rate">Current Rate (units/hr):</label>
                                 <input type="number" id="current-rate" min="0" max="100" step="0.1" placeholder="e.g., 3.5" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateInsulinAdjustment();}">
                             </div>
                             <div class="input-row" id="previous-bg-row" style="display: none;">
                                 <label for="previous-bg">Previous BG (mg/dL):</label>
                                 <input type="number" id="previous-bg" min="0" max="1500" placeholder="e.g., 250" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateInsulinAdjustment();}">
                             </div>
                             <div class="input-row">
                                 <label for="current-bg-adj">Current BG (mg/dL):</label>
                                 <input type="number" id="current-bg-adj" min="0" max="1500" placeholder="e.g., 210" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateInsulinAdjustment();}" oninput="togglePreviousBgField(this.value)">
                             </div>
                             <div class="input-checkbox-row">
                                <label for="type-1-dm">Type 1 DM:</label>
                                <input type="checkbox" id="type-1-dm" class="align-checkbox">
                            </div>
                         </div>
                         <div class="input-group">
                              <button onclick="calculateInsulinAdjustment()">Calculate Adjustment</button>
                         </div>
                         <div id="insulin-adjustment-results" class="results-container"></div>
                     </div>
                 </div>
                 
                 <!-- DKA/HHS PROTOCOL (Initially Hidden) -->
                 <div id="dka-hhs-protocol" style="display: none;">
                    <div class="dka-phase-tabs">
                        <button class="dka-phase-button active" data-dka-phase="phase1" onclick="switchDkaPhase('phase1')">Phase 1</button>
                        <button class="dka-phase-button" data-dka-phase="transition" onclick="switchDkaPhase('transition')">Transition Phase</button>
                        <button class="dka-phase-button" data-dka-phase="phase2" onclick="switchDkaPhase('phase2')">Phase 2</button>
                    </div>
                    <div class="input-group">
                        <a href="Insulin_DKA-HHS_032019.pdf" download>Download Protocol PDF</a>
                    </div>

                    <div id="dka-phase1-content" class="dka-phase-content active">
                        <div class="info-section">
                            <h3>Phase 1: Initiation</h3>
                            <p class="section-subtitle">Start infusion at 0.1 units/kg/hour.</p>
                            <div class="input-stack">
                                <div class="input-row">
                                    <label for="phase1-initiation-weight">Patient Weight (kg):</label>
                                    <input type="number" id="phase1-initiation-weight" min="0" max="500" step="0.1" placeholder="e.g., 70" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaInitiation();}">
                                </div>
                            </div>
                            <div class="input-group">
                                <button onclick="calculateDkaInitiation()">Calculate Initial Rate</button>
                            </div>
                            <div id="phase1-initiation-results" class="results-container"></div>
                        </div>
                        <div class="info-section">
                            <h3>Phase 1: Continuation (BG > 250)</h3>
                            <p class="section-subtitle">Adjust hourly based on BG drop after the first hour.</p>
                            <p class="section-subtitle">Proceed to Transition Phase when Blood Glucose is ≤ 250 mg/dL.</p>
                            <div class="input-stack">
                                <div class="input-row">
                                    <label for="phase1-current-rate">Current Rate (units/hr):</label>
                                    <input type="number" id="phase1-current-rate" min="0" max="100" step="0.1" placeholder="e.g., 7.0" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaPhase1Continuation();}">
                                </div>
                                <div class="input-row">
                                    <label for="phase1-rate-change">BG Drop (mg/dL/hr):</label>
                                    <input type="number" id="phase1-rate-change" min="0" max="500" placeholder="e.g., 60" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaPhase1Continuation();}">
                                </div>
                            </div>
                            <div class="input-group">
                                <button onclick="calculateDkaPhase1Continuation()">Calculate Adjustment</button>
                            </div>
                            <div id="phase1-continuation-results" class="results-container"></div>
                        </div>
                    </div>

                    <div id="dka-transition-content" class="dka-phase-content">
                        <div class="info-section">
                            <h3>Transition Phase</h3>
                             <p class="section-subtitle">GOAL BG: 150-200 mg/dL</p>
                             <div class="phase-gate">
                                <i class="fas fa-arrow-down"></i>
                                <p>Proceed to Transition Phase ONLY when Blood Glucose is <strong>≤ 250 mg/dL</strong>.</p>
                                <p>DO NOT return to phase 1.</p>
                                <p>With next BG, move to Phase 2.</p>
                             </div>
                             <div class="input-stack">
                                <div class="input-row">
                                    <label for="transition-weight">Patient Weight (kg):</label>
                                    <input type="number" id="transition-weight" min="0" max="500" step="0.1" placeholder="e.g., 70" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaTransition();}">
                                </div>
                                <div class="input-row">
                                    <label for="transition-current-rate">Current Rate (units/hr):</label>
                                    <input type="number" id="transition-current-rate" min="0" max="100" step="0.1" placeholder="e.g., 7.0" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaTransition();}">
                                </div>
                            </div>
                            <div class="input-group">
                                <button onclick="calculateDkaTransition()">Calculate Transition</button>
                            </div>
                            <div id="transition-results" class="results-container"></div>
                        </div>
                    </div>

                    <div id="dka-phase2-content" class="dka-phase-content">
                        <div class="info-section">
                            <h3>Phase 2: Titration</h3>
                            <p class="section-subtitle">Goal BG is 150-200 mg/dL.</p>
                             <div class="input-stack">
                                <div class="input-row">
                                    <label for="phase2-current-rate">Current Rate (units/hr):</label>
                                    <input type="number" id="phase2-current-rate" min="0" max="100" step="0.1" placeholder="e.g., 3.5" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaPhase2();}">
                                </div>
                                <div class="input-row">
                                    <label for="phase2-current-bg">Current BG (mg/dL):</label>
                                    <input type="number" id="phase2-current-bg" min="0" max="1500" placeholder="e.g., 180" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaPhase2();}">
                                </div>
                            </div>
                            <div class="input-group">
                                <button onclick="calculateDkaPhase2()">Calculate Phase 2</button>
                            </div>
                            <div id="phase2-results" class="results-container"></div>
                        </div>
                    </div>
                 </div>
             </div>
             <!-- Sidebars for Insulin Protocols -->
             <div id="non-dka-sidebar" style="display: block;">
                 <div class="lab-monitoring-section">
                     <h2>Key Points</h2>
                     <div class="lab-monitoring-content">
                         <div class="column">
                             <h3>Monitoring</h3>
                             <ul>
                                 <li>Check blood glucose <strong>hourly</strong>.</li>
                                 <li>If stable in target range (140-180mg/dL) for 4 hrs, decrease to <strong>every 2 hours</strong> BG checks.</li>
                                 <li>Check BMP at baseline and <strong>every 4 hours</strong> during infusion.</li>
                             </ul>
                             <h3>Safety & Prerequisites</h3>
                             <ul>
                                 <li class="critical-warning">Do NOT start infusion if potassium is <strong>&lt; 3.3 mEq/L</strong>.</li>
                                 <li>Investigate any unexplained hypo or hyperglycemia.</li>
                             </ul>
                             <h3>Adjustments & Special Situations</h3>
                             <ul>
                                 <li>Adjust insulin for any changes in glucose source (diet, TPN, etc.).</li>
                                 <li>If a glucose source is held, <strong>reduce insulin rate by 50%</strong> and perform hourly BG checks.</li>
                                 <li>If transport, <strong>titrate/protocol + hourly BG checks</strong> or <strong>turn infusion OFF</strong> if monitoring isn't possible and resume protocol when return to.</li>
                                 <li>Ensure an alternative glycemic plan is ordered before discontinuing the infusion.</li>
                             </ul>
                             <h3>Discontinuing Infusion</h3>
                             <ul>
                                 <li>Consider switching to subcutaneous insulin when BG is stable (100-180 mg/dL) for 6+ hours.</li>
                                 <li><strong>Overlap:</strong> Administer subcutaneous insulin 1-2 hours <strong>before</strong> stopping the infusion.</li>
                                 <li><strong>NPO Patients:</strong> Give 80% of the 24hr infusion total as a long-acting basal dose.</li>
                                 <li><strong>PO Intake:</strong> Give 50% of the 24hr infusion total as a basal dose and start mealtime insulin.</li>
                             </ul>
                         </div>
                     </div>
                 </div>
             </div>
             <div id="dka-sidebar" style="display: none;">
                 <div class="lab-monitoring-section">
                    <h2>Key Points: DKA/HHS</h2>
                    <div class="lab-monitoring-content">
                        <div class="column">
                            <h3>Safety & Prerequisites</h3>
                            <ul>
                                <li class="critical-warning">Do not start insulin until K+ is > 3.3 mEq/L.</li>
                                <li>Use only Blue Low Sorbing infusion set (prime with 20mL).</li>
                                <li>Change tubing q24hr with new solution bag.</li>
                                <li class="critical-warning">Avoid transitioning off infusion overnight.</li>
                            </ul>
                            <h3>Monitoring & Labs</h3>
                            <ul>
                                <li>Check blood glucose <strong>hourly</strong>.</li>
                                <li>Draw labs STAT q2h until K+ is stable (4.0-5.0) for 4h, then q4h.</li>
                                <li>Check BG at discontinuation and 2 hours post-discontinuation.</li>
                            </ul>
                             <h3>Rate Adjustments & Special Situations</h3>
                             <ul>
                                <li>Notify provider if rate is > 20 units/hr or < 2.0 units/hr for 4 hours.</li>
                                <li>When BG < 150 mg/dL: increase D5½NS to 150 mL/hr and check BG in 1 hour. Call MD if still < 150.</li>
                             </ul>
                            <h3>Discontinuing Infusion</h3>
                            <ul>
                                <li>Call physician when anion gap < 12 for 4 hours (2 chemistries) to consider transition.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                 <div class="lab-monitoring-section" style="margin-top: 2rem;">
                     <h3>Bolus (if ordered)</h3>
                     <div class="input-checkbox-row" style="justify-content: center; margin-bottom: 1rem;">
                         <label for="show-bolus-calc">Calculate Bolus?</label>
                         <input type="checkbox" id="show-bolus-calc" class="align-checkbox" onchange="toggleBolusCalculator(this.checked)">
                     </div>
                     <div id="bolus-calculator-content" style="display: none;">
                         <p class="section-subtitle">Calculates Regular insulin at 0.1 units/kg (Max 10 units) and includes a weight converter.</p>
                         <div class="input-stack">
                             <div class="input-row">
                                 <label for="lbs-input">Pounds (lbs):</label>
                                 <input type="number" id="lbs-input" placeholder="e.g., 154" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaBolus();}" oninput="convertLbsToKg(this.value)">
                             </div>
                             <div class="input-row">
                                 <label for="kg-input">Kilograms (kg):</label>
                                 <input type="number" id="kg-input" placeholder="e.g., 70" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaBolus();}" oninput="convertKgToLbs(this.value)">
                             </div>
                             <hr>
                             <div class="input-row">
                                 <label for="bolus-weight">Patient Weight (kg):</label>
                                 <input type="number" id="bolus-weight" min="0" max="500" step="0.1" placeholder="e.g., 70" onkeypress="if(event.key==='Enter'){event.preventDefault();calculateDkaBolus();}">
                             </div>
                         </div>
                         <div class="input-group">
                             <button onclick="calculateDkaBolus()">Calculate Bolus</button>
                         </div>
                         <div id="bolus-results" class="results-container"></div>
                    </div>
                 </div>
             </div>
         </div>

         <!-- Calculator Tab -->
         <div id="calculator-protocol-content" class="protocol-content">
             <div class="container">
                 <h1>Calculator Tools</h1>

                 <div class="calculator-sections">
                     <!-- Weight Converter Section -->
                     <div class="calc-section">
                         <h2><i class="fas fa-weight-hanging"></i> Weight Converter</h2>
                         <div class="weight-converter">
                             <div class="input-group">
                                 <label for="calc-lbs-input">Pounds (lbs):</label>
                                 <input type="number" id="calc-lbs-input" placeholder="Enter weight in pounds" step="0.1" oninput="convertCalcLbsToKg(this.value)">
                             </div>
                             <div class="conversion-arrow">
                                 <i class="fas fa-exchange-alt"></i>
                             </div>
                             <div class="input-group">
                                 <label for="calc-kg-input">Kilograms (kg):</label>
                                 <input type="number" id="calc-kg-input" placeholder="Enter weight in kilograms" step="0.1" oninput="convertCalcKgToLbs(this.value)">
                             </div>
                         </div>
                     </div>

                     <!-- Basic Math Calculator Section -->
                     <div class="calc-section">
                         <h2><i class="fas fa-calculator"></i> Basic Calculator</h2>
                         <div class="basic-calculator">
                             <div class="calc-display">
                                 <input type="text" id="calc-display" readonly placeholder="0">
                             </div>
                             <div class="calc-buttons">
                                 <button class="calc-btn calc-clear" onclick="clearCalculator()">C</button>
                                 <button class="calc-btn calc-clear" onclick="clearEntry()">CE</button>
                                 <button class="calc-btn calc-operator" onclick="appendToDisplay('/')" title="Divide">÷</button>
                                 <button class="calc-btn calc-operator" onclick="appendToDisplay('*')" title="Multiply">×</button>

                                 <button class="calc-btn calc-number" onclick="appendToDisplay('7')">7</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('8')">8</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('9')">9</button>
                                 <button class="calc-btn calc-operator" onclick="appendToDisplay('-')" title="Subtract">-</button>

                                 <button class="calc-btn calc-number" onclick="appendToDisplay('4')">4</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('5')">5</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('6')">6</button>
                                 <button class="calc-btn calc-operator" onclick="appendToDisplay('+')" title="Add">+</button>

                                 <button class="calc-btn calc-number" onclick="appendToDisplay('1')">1</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('2')">2</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('3')">3</button>
                                 <button class="calc-btn calc-equals" onclick="calculateResult()" rowspan="2" title="Equals">=</button>

                                 <button class="calc-btn calc-number calc-zero" onclick="appendToDisplay('0')">0</button>
                                 <button class="calc-btn calc-number" onclick="appendToDisplay('.')">.</button>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>

         <!-- AI Assistant Tab -->
        <div id="gemini-ai-protocol-content" class="protocol-content">
            <div class="container">
                <h1>Dat AI Clinical Assistant</h1>
                <div class="ai-disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <p><strong>Important:</strong> This AI assistant is for supplementary information only. It does not replace clinical judgment or professional medical advice. Always verify information independently.</p>
                </div>
                
                <!-- AI Assistant is now ready to use with embedded key -->

                <div id="chat-interface" class="chat-interface" style="display: block;">
                    <div class="chat-container">
                        <div class="chat-box" id="gemini-chat-box">
                            <div class="chat-message bot-message">
                                <p>Hello! I'm an AI assistant for clinical information. Remember, I'm supplementary only - always use your clinical judgment and verify any information independently.</p>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" id="gemini-input" placeholder="Ask a clinical question..." onkeypress="if(event.key==='Enter'){event.preventDefault();handleGeminiChat();}">
                            <button id="gemini-send-btn"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

         <!-- Other Protocols Tab -->
         <div id="other-protocol-content" class="protocol-content">
             <div class="container">
                 <h1>Other Protocols</h1>

                 <div class="coming-soon-section">
                     <div class="coming-soon-content">
                         <i class="fas fa-clock fa-3x"></i>
                         <h2>Additional Protocols Coming Soon</h2>
                         <p>This section will be updated with additional clinical protocols and tools to support healthcare providers.</p>

                         <div class="planned-features">
                             <h3>Planned Features:</h3>
                             <ul>
                                 <li><i class="fas fa-heart"></i> Cardiac Protocols</li>
                                 <li><i class="fas fa-lungs"></i> Respiratory Protocols</li>
                                 <li><i class="fas fa-prescription-bottle-alt"></i> Medication Dosing Guidelines</li>
                                 <li><i class="fas fa-chart-pie"></i> Laboratory Reference Ranges</li>
                                 <li><i class="fas fa-file-medical"></i> Emergency Protocols</li>
                             </ul>
                         </div>

                         <div class="update-notice">
                             <p><strong>Note:</strong> Content updates will be implemented based on clinical needs and user feedback.</p>
                         </div>
                     </div>
                 </div>

                 <!-- Quick Reference Section -->
                 <div class="info-section">
                     <h3><i class="fas fa-info-circle"></i> Quick Clinical References</h3>
                     <div class="reference-grid">
                         <div class="reference-card">
                             <h4>Heparin Therapy</h4>
                             <ul>
                                 <li>Normal aPTT: 25-35 seconds</li>
                                 <li>Therapeutic aPTT: 70-90 seconds</li>
                                 <li>Critical aPTT: >100 seconds</li>
                             </ul>
                         </div>
                         <div class="reference-card">
                             <h4>Blood Glucose</h4>
                             <ul>
                                 <li>Normal (fasting): 70-100 mg/dL</li>
                                 <li>Non-DKA Target: 140-180 mg/dL</li>
                                 <li>DKA Phase 2 Target: 150-200 mg/dL</li>
                             </ul>
                         </div>
                         <div class="reference-card">
                             <h4>Insulin Protocols</h4>
                             <ul>
                                 <li>Hypoglycemia: BG < 70 mg/dL</li>
                                 <li>Critical High: BG > 600 mg/dL</li>
                                 <li>Maximum Rate: 20 units/hr (notify provider)</li>
                             </ul>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
         
     </div> <!-- This closes .tab-content -->
 </div> <!-- This closes .main-wrapper -->

 <!-- Confirmation Modal -->
 <div id="confirmation-modal" class="modal">
     <div class="modal-content">
         <h3 class="critical-header"><i class="fas fa-exclamation-triangle"></i> Confirm Critical Calculation</h3>
         <p id="confirmation-message"></p>
         <div class="modal-values" id="modal-values"></div>
         <p class="modal-warning">Please verify these values before proceeding. This calculation will be logged.</p>
         <div class="modal-buttons">
             <button onclick="confirmCalculation()" class="confirm-btn">Confirm & Calculate</button>
             <button onclick="cancelCalculation()" class="cancel-btn">Cancel</button>
         </div>
     </div>
 </div>

 <!-- Feedback Modal -->
<div id="feedback-modal" class="modal">
  <div class="modal-content">
    <h3><i class="fas fa-comment-dots"></i> Provide Feedback</h3>
    <p>Your feedback is valuable for improving this tool. Please report any issues or suggestions.</p>

    <!-- Formspree Form -->
    <form id="feedback-form" action="https://formspree.io/f/mjkedzbv" method="POST" class="feedback-form">
        <input type="text" name="name" id="feedback-name" placeholder="Your Name">
        <input type="email" name="email" placeholder="Your JPS Email (Optional)">
        <textarea name="message" id="feedback-text" placeholder="Describe the error, mistake, or improvement..." rows="4" required></textarea>
        <div class="modal-buttons">
            <button type="submit" class="confirm-btn">Submit</button>
            <button type="button" onclick="toggleFeedback()" class="cancel-btn">Cancel</button>
        </div>
    </form>
  </div>
</div>


 <footer class="site-footer">
    <p>© 2025 BANH BAO</p>
    <p>Developed, tested, and oversaw by Banh Bao</p>
</footer>

 <script src="./logic.js"></script>
 <!-- Service Worker temporarily disabled for debugging -->
 <!--
 <script>
     // Register Service Worker for offline capability
     if ('serviceWorker' in navigator) {
         navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed'));
     }
 </script>
 -->

</body>
</html>

